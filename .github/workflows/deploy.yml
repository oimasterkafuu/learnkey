name: Build and Deploy

on:
    push:
        tags:
            - v*

    workflow_dispatch:

permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - name: Setup Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: 18

            - name: Install dependencies
              run: yarn install
            - name: Build
              run: yarn build

            - name: Zip
              run: zip -r dist.zip dist
            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: dist
                  path: dist.zip

    deploy:
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: Production
            url: ${{ steps.deploy.outputs.page_url }}
        steps:
            - name: Download artifact
              id: download
              uses: actions/download-artifact@v2
              with:
                  name: dist
            - name: Unzip
              run: unzip -o dist.zip
            - name: Setup Pages
              uses: actions/configure-pages@v3
            - name: Upload page artifact
              uses: actions/upload-pages-artifact@v2
              with:
                  path: './dist'
            - name: Deploy to Pages
              id: deploy
              uses: actions/deploy-pages@v2

    release:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download artifact
              id: download
              uses: actions/download-artifact@v2
              with:
                  name: dist
            - name: SHA256
              # run: echo "::set-output name=sha256::$(sha256sum dist.zip | cut -d ' ' -f 1)"
              run: echo "sha256=$(sha256sum dist.zip | cut -d ' ' -f 1)" >> $GITHUB_ENV
              id: sha256
            - name: Release
              uses: softprops/action-gh-release@v1
              with:
                  files: './dist.zip'
                  tag_name: ${{ github.ref }}
                  name: ${{ github.ref_name }}
                  body: |
                      ## Release ${{ github.ref_name }} :tada:

                      Hello, there :wave: We've got release ${{ github.ref_name }} for you!

                      You can download the `dist.zip` file from the Assets section below to get the automatically built static resources and deploy them to your own server.

                      The SHA256 checksum of the `dist.zip` file is `${{ env.sha256 }}`. You can use this to verify the integrity of the file :lock:

                      Or, you can go to the [online demo](https://learn.oimaster.top/) to view the latest production version :rocket: Remember to clear the cache of your browser if you have visited the demo before v0.5.0-beta :wink:

                      Enjoy! :kissing_heart:
                      
                      ---

                      ## 发行版 ${{ github.ref_name }} :tada:

                      您好，这里是 oimasterkafuu :wave: 我们为您带来了 ${{ github.ref_name }} 版本的发布！

                      您可以从下面的 Assets 部分下载 `dist.zip` 文件，获取自动构建的静态资源并将其部署到您自己的服务器上。

                      `dist.zip` 文件的 SHA256 校验和为 `${{ env.sha256 }}`。您可以使用它来验证文件的完整性 :lock:

                      或者，您可以前往[在线演示](https://learn.oimaster.top/)查看最新的生产版本 :rocket: 如果您在 v0.5.0-beta 版本之前访问过演示，请记得清除浏览器缓存 :wink:

                      祝您使用愉快！ :kissing_heart:
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
